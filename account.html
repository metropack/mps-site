<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>My Account ‚Äî MPS Inc Invoice App</title>
  <link rel="icon" href="data:," />
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; connect-src 'self' https://printshopinvoice-api-backend.onrender.com;">
  <style>
    :root { --bg:#0f172a; --card:#111827; --text:#e5e7eb; --muted:#9ca3af; --accent:#22c55e; --blue:#38bdf8; --red:#ef4444; }
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text)}
    .wrap{max-width:960px;margin:0 auto;padding:28px 18px 80px}
    header{display:flex;justify-content:space-between;align-items:center}
    a.link{color:#93c5fd;text-decoration:none}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:18px;margin-top:20px}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01));border:1px solid #334155;border-radius:16px;padding:22px}
    h2{margin:0 0 10px}
    label{display:block;font-size:13px;color:#cbd5e1;margin-bottom:6px}
    /* Make textarea look like inputs */
    input, textarea {
      width:100%;
      padding:12px 14px;
      border-radius:10px;
      border:1px solid #334155;
      background:#0b1220;
      color:#e5e7eb;
      font:inherit;
    }
    textarea{min-height:96px;line-height:1.4;resize:vertical}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    /* allow items inside .row to span both columns */
    .col-span-2{grid-column:1 / -1}
    .btn{display:inline-block;background:var(--accent);color:#052e16;font-weight:700;padding:12px 18px;border-radius:10px;border:0;cursor:pointer}
    .btn.blue{background:var(--blue);color:#06283b}
    .btn.red{background:var(--red);color:#fff}
    .muted{color:var(--muted)}
    .stack{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .msg{margin-top:10px;color:#cbd5e1}.error{color:#fca5a5}
    @media (max-width: 860px){ .grid{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>üßæ <strong>MPS Inc ‚Ä¢ Invoice App</strong></div>
      <div class="stack">
        <a class="link" href="/">Home</a>
        <a class="link" href="#" id="logout">Log out</a>
      </div>
    </header>

    <div class="grid">
      <!-- Profile -->
      <section class="card">
        <h2>Profile</h2>
        <div class="muted" id="emailLine"></div>
        <form id="profileForm" style="display:grid;gap:12px;margin-top:10px">
          <div class="row">
            <div>
              <label for="name">Name</label>
              <input id="name" />
            </div>
            <div>
              <label for="company">Company</label>
              <input id="company" />
            </div>
          </div>

          <div class="row">
            <div>
              <label for="phone">Phone</label>
              <input id="phone" />
            </div>
            <!-- full-width address inside the row -->
            <div class="col-span-2">
              <label for="address">Address</label>
              <textarea id="address" name="address" rows="3"
                placeholder="Street&#10;Suite / Apt&#10;City, ST ZIP"></textarea>
            </div>
          </div>

          <button class="btn" type="submit" id="saveBtn">Update profile</button>
          <div id="pmsg" class="msg"></div>
        </form>
      </section>

      <!-- Billing -->
      <section class="card">
        <h2>Billing & Subscription</h2>
        <div id="status" class="muted">Loading‚Ä¶</div>
        <div class="stack">
          <button class="btn blue" id="manageBilling">Manage payment / billing</button>
          <button class="btn red"  id="cancel">Cancel at period end</button>
          <button class="btn"      id="resume" style="display:none">Resume subscription</button>
        </div>

        <div style="margin-top:18px">
          <h3 style="margin:0 0 8px">Download the app</h3>
          <div class="stack">
            <button class="btn" id="dlWin">Download for Windows</button>
          </div>
          <div id="dlMsg" class="msg"></div>
        </div>
      </section>
    </div>

    <section class="card" style="margin-top:18px">
      <h2>Security</h2>
      <p class="muted">Your payment details are managed securely by Stripe. Use ‚ÄúManage payment / billing‚Äù to update cards or see invoices.</p>

      <!-- Change Password -->
      <form id="pwForm" style="display:grid;gap:12px;max-width:420px;margin-top:10px">
        <div>
          <label for="curPw">Current password</label>
          <input id="curPw" type="password" required />
        </div>
        <div>
          <label for="newPw">New password</label>
          <input id="newPw" type="password" minlength="6" required />
        </div>
        <div>
          <label for="newPw2">Confirm new password</label>
          <input id="newPw2" type="password" minlength="6" required />
        </div>
        <button class="btn" type="submit">Change password</button>
        <div id="pwMsg" class="msg"></div>
      </form>
    </section>
  </div>

  <script>
    const API = 'https://printshopinvoice-api-backend.onrender.com';
    const token = localStorage.getItem('psi_token');
    if (!token) window.location.href = '/login.html';

    const emailLine = document.getElementById('emailLine');
    const statusBox = document.getElementById('status');
    const cancelBtn = document.getElementById('cancel');
    const resumeBtn = document.getElementById('resume');
    const pmsg = document.getElementById('pmsg');
    const saveBtn = document.getElementById('saveBtn');

    document.getElementById('logout').onclick = () => {
      localStorage.removeItem('psi_token');
      localStorage.removeItem('psi_email');
      window.location.href = '/';
    };

    (async function init(){
      // who am I
      const me = await fetch(API + '/api/auth/me', { headers:{Authorization:'Bearer '+token}});
      const meData = await me.json();
      if (me.ok) {
        emailLine.textContent = 'Signed in as ' + (meData.email || localStorage.getItem('psi_email') || '');
      }

      // profile
      const pr = await fetch(API + '/api/profile', { headers:{Authorization:'Bearer '+token}});
      const p = await pr.json();
      if (pr.ok) {
        document.getElementById('name').value = p.name || '';
        document.getElementById('company').value = p.company || '';
        document.getElementById('phone').value = p.phone || '';
        document.getElementById('address').value = p.address || '';
      }

      await loadStatus();
    })();

    async function loadStatus(){
      const r = await fetch(API + '/api/billing/status', { headers:{Authorization:'Bearer '+token}});
      const d = await r.json();
      if (!r.ok) { statusBox.textContent = d.error || 'Unable to load status'; return; }

      let t = 'Status: ' + (d.subscription_status || 'unknown');
      if (d.cancel_at_period_end) t += ' ‚Ä¢ will cancel at next renewal';
      if (d.current_period_end) {
        const dt = new Date(d.current_period_end * 1000);
        t += ' ‚Ä¢ period ends ' + dt.toLocaleDateString();
      }
      statusBox.textContent = t;

      cancelBtn.style.display = d.cancel_at_period_end ? 'none' : 'inline-block';
      resumeBtn.style.display = d.cancel_at_period_end ? 'inline-block' : 'none';
    }

    document.getElementById('manageBilling').onclick = async () => {
      const r = await fetch(API + '/api/billing/portal', { method:'POST', headers:{ 'Authorization':'Bearer '+token }});
      const d = await r.json();
      if (r.ok && d.url) window.location.href = d.url;
      else alert(d.error || 'Unable to open billing portal');
    };

    cancelBtn.onclick = async () => {
      if (!confirm('Cancel at the end of the current billing period?')) return;
      const r = await fetch(API + '/api/billing/cancel', { method:'POST', headers:{Authorization:'Bearer '+token}});
      if (r.ok) loadStatus(); else alert('Unable to update subscription');
    };

    resumeBtn.onclick = async () => {
      const r = await fetch(API + '/api/billing/resume', { method:'POST', headers:{Authorization:'Bearer '+token}});
      if (r.ok) loadStatus(); else alert('Unable to resume subscription');
    };

    document.getElementById('profileForm').addEventListener('submit', async (e)=>{
      e.preventDefault(); pmsg.textContent=''; saveBtn.disabled = true;
      const body = {
        name: document.getElementById('name').value.trim(),
        company: document.getElementById('company').value.trim(),
        phone: document.getElementById('phone').value.trim(),
        address: document.getElementById('address').value.trim(),
      };
      const r = await fetch(API + '/api/profile', {
        method:'POST',
        headers:{'Content-Type':'application/json', Authorization:'Bearer '+token},
        body: JSON.stringify(body)
      });
      const d = await r.json().catch(()=> ({}));
      pmsg.textContent = r.ok ? 'Profile updated ‚úÖ' : (d.error || 'Failed to save');
      pmsg.className = 'msg' + (r.ok ? '' : ' error');
      saveBtn.disabled = false;
    });

    // Change password
    const pwForm = document.getElementById('pwForm');
    const pwMsg  = document.getElementById('pwMsg');

    pwForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      pwMsg.textContent = '';

      const cur = document.getElementById('curPw').value;
      const npw = document.getElementById('newPw').value;
      const npw2 = document.getElementById('newPw2').value;

      if (npw !== npw2) {
        pwMsg.textContent = 'New passwords do not match';
        pwMsg.className = 'msg error';
        return;
      }
      if (npw.length < 6) {
        pwMsg.textContent = 'New password must be at least 6 characters';
        pwMsg.className = 'msg error';
        return;
      }

      try {
        const r = await fetch(API + '/api/auth/change-password', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
          body: JSON.stringify({ currentPassword: cur, newPassword: npw })
        });
        const d = await r.json().catch(()=> ({}));
        if (r.ok) {
          pwMsg.textContent = 'Password changed ‚úÖ';
          pwMsg.className = 'msg';
        } else {
          pwMsg.textContent = d.error || 'Failed to change password';
          pwMsg.className = 'msg error';
        }
      } catch (_) {
        pwMsg.textContent = 'Network error';
        pwMsg.className = 'msg error';
      }
    });

    // Signed downloads
    (function setupDownloads() {
      const msgEl = document.getElementById('dlMsg');
      const setMsg = (t, bad=false) => { msgEl.textContent = t || ''; msgEl.className = 'msg' + (bad ? ' error' : ''); };

      async function getLink(path) {
        const res = await fetch(API + path, {
          method: 'GET',
          headers: token ? { Authorization: 'Bearer ' + token } : {},
          cache: 'no-store'
        });
        const data = await res.json().catch(()=> ({}));
        if (!res.ok || !data.url) throw new Error(data.error || 'Could not get download link');
        return data.url;
      }

      document.getElementById('dlWin')?.addEventListener('click', async () => {
        try { setMsg('Preparing your Windows download‚Ä¶'); const url = await getLink('/api/download/win'); window.location.href = url; setMsg(''); }
        catch (e) { setMsg(e.message, true); }
      });
    })();
  </script>
</body>
</html>
