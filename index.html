<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Sign up – Print Shop Invoice</title>

  <!-- CSP: allow calling your backend on Render -->
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self';
                 img-src 'self' data:;
                 style-src 'self' 'unsafe-inline';
                 script-src 'self';
                 connect-src 'self' https://printshopinvoice-api-backend.onrender.com;">

  <style>
    :root { --bg:#f7fafc; --card:#fff; --text:#0f172a; --muted:#475569; --brand:#0ea5e9; --brand-2:#0284c7; }
    * { box-sizing:border-box }
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;color:var(--text);background:var(--bg)}
    header{padding:28px 20px;text-align:center}
    header h1{margin:0 0 8px}
    header p{margin:0;color:var(--muted)}
    main{display:grid;place-items:center;padding:0 16px 40px}
    .card{background:var(--card);width:100%;max-width:560px;margin-top:18px;padding:28px;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.08)}
    label{display:block;margin:12px 0 6px;font-weight:600}
    input{width:100%;padding:12px;border:1px solid #e5e7eb;border-radius:10px}
    button{margin-top:16px;padding:12px 16px;border:none;border-radius:10px;background:var(--brand);color:#fff;font-weight:700;cursor:pointer}
    button:hover{background:var(--brand-2)}
    .msg{margin-top:12px;font-size:14px;color:var(--muted)}
    .row{margin-top:16px;font-size:14px}
    a.link{color:var(--brand);text-decoration:none;font-weight:600}
    a.link:hover{text-decoration:underline}
    .features{display:grid;gap:10px;margin-top:10px;color:var(--muted);font-size:14px}
    .features li{margin-left:18px}
  </style>
</head>
<body>
  <header>
    <h1>Print Shop Invoice</h1>
    <p>Sign up to create your account. You’ll be taken to checkout to start your subscription.</p>
  </header>

  <main>
    <section class="card">
      <form id="signupForm" autocomplete="on">
        <label for="email">Email</label>
        <input id="email" type="email" required placeholder="you@company.com"/>

        <label for="password">Password</label>
        <input id="password" type="password" minlength="6" required placeholder="At least 6 characters"/>

        <button type="submit" id="btn">Sign up</button>
        <div id="msg" class="msg"></div>

        <div class="row">Already have an account? <a class="link" href="/login.html">Log in</a></div>
      </form>
    </section>

    <section class="card" style="margin-top:16px">
      <h3 style="margin:0 0 8px">What you get</h3>
      <ul class="features">
        <li>Create and manage invoices & estimates</li>
        <li>Customer and product management</li>
        <li>Desktop app access (Windows)</li>
        <li>Cancel anytime</li>
      </ul>
    </section>
  </main>

  <script>
    // === Configure your backend base URL ===
    const API_BASE = 'https://printshopinvoice-api-backend.onrender.com';

    const form = document.getElementById('signupForm');
    const msg  = document.getElementById('msg');
    const btn  = document.getElementById('btn');

    async function api(path, body, token) {
      const res = await fetch(API_BASE + path, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          ...(token ? { Authorization: 'Bearer ' + token } : {})
        },
        body: JSON.stringify(body || {})
      });
      const data = await res.json().catch(() => ({}));
      if (!res.ok) {
        throw new Error(data.error || ('HTTP ' + res.status));
      }
      return data;
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;

      btn.disabled = true;
      btn.textContent = 'Creating account…';
      msg.textContent = '';

      try {
        // 1) Create the user (password is created here — on YOUR site)
        const reg = await api('/api/auth/register', { email, password });
        const token = reg.token;
        localStorage.setItem('psi_token', token);
        localStorage.setItem('psi_email', email);

        // 2) Start checkout (auth required)
        btn.textContent = 'Starting checkout…';
        const session = await api('/api/auth/create-checkout-session', {}, token);

        // 3) Redirect to Stripe
        window.location.href = session.url;
      } catch (err) {
        msg.textContent = 'Error: ' + err.message;
        if (/already registered/i.test(err.message)) {
          msg.innerHTML += ' — <a class="link" href="/login.html">Log in</a>';
        }
        btn.disabled = false;
        btn.textContent = 'Sign up';
      }
    });
  </script>
</body>
</html>
