<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Payment successful ‚Äì MPS Inc Invoice App</title>
  <style>
    :root { --bg:#f7fafc; --card:#ffffff; --text:#0f172a; --muted:#475569; --ok:#16a34a; --info:#0ea5e9; }
    * { box-sizing: border-box; }
    body{font-family:system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin:0; background:var(--bg); color:var(--text)}
    .wrap{display:grid;place-items:center;min-height:100vh;padding:24px}
    .card{background:var(--card);max-width:760px;width:100%;padding:32px;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.08)}
    h1{margin:0 0 8px}
    p{margin:0 0 12px}
    .muted{color:var(--muted)}
    .row{display:flex;gap:12px;flex-wrap:wrap;margin-top:10px}
    .btn{display:inline-block;padding:12px 18px;border-radius:10px;text-decoration:none;font-weight:600;border:0;cursor:pointer}
    .btn.ok{background:var(--ok);color:#fff}
    .btn.info{background:var(--info);color:#fff}
    .btn.ghost{background:#e2e8f0;color:#0f172a}
    #retry{display:none}
    #trouble{display:none}
  </style>
</head>
<body>
  <div class="wrap">
    <main class="card">
      <h1>üéâ Payment successful</h1>
      <p class="muted" id="state">Verifying your subscription‚Ä¶</p>

      <div class="row" id="actions" style="margin-top:14px">
        <a class="btn ok" id="toAccount" href="/account.html" style="display:none">Go to my account</a>
        <button class="btn info" id="retry">Retry check</button>
        <a class="btn ghost" href="/">Return to home</a>
      </div>

      <p class="muted" id="trouble">This can take a few seconds while Stripe finalizes your subscription. If it takes longer, click ‚ÄúRetry check‚Äù.</p>
    </main>
  </div>

  <script>
    const API = 'https://printshopinvoice-api-backend.onrender.com';
    const stateEl = document.getElementById('state');
    const retryBtn = document.getElementById('retry');
    const toAccount = document.getElementById('toAccount');
    const trouble = document.getElementById('trouble');

    const token = localStorage.getItem('psi_token');
    const sessionId = new URLSearchParams(location.search).get('session_id');

    // If the user isn't signed in locally, send them to login with a hint.
    if (!token) {
      location.replace('/login.html?paid=1' + (sessionId ? '&session_id=' + encodeURIComponent(sessionId) : ''));
    }

    function setState(t) { stateEl.textContent = t; }

    // Hit /billing/status first to force a fresh read from Stripe and sync the DB.
    async function syncStatus() {
      try {
        const r = await fetch(API + '/api/billing/status', {
          headers: { Authorization: 'Bearer ' + token, 'Cache-Control': 'no-store' }
        });
        // We don‚Äôt need the body here; your endpoint already syncs subscription_status in DB.
        await r.json().catch(() => ({}));
      } catch (_) {
        // ignore; we still try license-check next
      }
    }

    async function isActive() {
      const r = await fetch(API + '/api/auth/license-check', {
        headers: { Authorization: 'Bearer ' + token, 'Cache-Control': 'no-store' }
      });
      const d = await r.json().catch(() => ({}));
      return !!d.subscription_active;
    }

    async function waitForActive(attempts = 6) {
      // ~0s, 1s, 2s, 4s, 4s, 4s ‚âà ~15s max
      const delays = [0, 1000, 2000, 4000, 4000, 4000].slice(0, attempts);
      for (let i = 0; i < delays.length; i++) {
        if (delays[i]) await new Promise(r => setTimeout(r, delays[i]));
        try {
          await syncStatus(); // force-refresh from Stripe each pass
          if (await isActive()) return true;
        } catch (_) {}
      }
      return false;
    }

    async function run(initial = false) {
      try {
        if (initial) setState('Verifying your subscription‚Ä¶');
        const ok = await waitForActive(6);
        if (ok) {
          setState('All set! Redirecting to your account‚Ä¶');
          toAccount.style.display = 'inline-block';
          // small delay so users see the success, then go
          setTimeout(() => location.replace('/account.html'), 600);
          return;
        }
        // Not active yet ‚Äî show retry UI (but not ‚Äústuck‚Äù)
        setState('Payment received. Waiting for subscription to activate‚Ä¶');
        retryBtn.style.display = 'inline-block';
        trouble.style.display = 'block';
      } catch (e) {
        setState('Could not verify subscription right now.');
        retryBtn.style.display = 'inline-block';
        trouble.style.display = 'block';
      }
    }

    retryBtn.addEventListener('click', async (e) => {
      e.preventDefault();
      retryBtn.disabled = true;
      setState('Re-checking‚Ä¶');
      try {
        const ok = await waitForActive(6);
        if (ok) {
          setState('All set! Redirecting to your account‚Ä¶');
          toAccount.style.display = 'inline-block';
          setTimeout(() => location.replace('/account.html'), 400);
        } else {
          setState('Still waiting for activation‚Ä¶');
        }
      } finally {
        retryBtn.disabled = false;
      }
    });

    // Kick off the flow
    run(true);
  </script>
</body>
</html>
